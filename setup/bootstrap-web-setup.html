<!DOCTYPE html>
<html lang="en">

    <head>
        <title>Bootstrap Budget! Web Setup</title>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <script>
            const hostUrl = new URL(document.URL);
            const hostname = hostUrl.hostname;

            $(document).ready(function() {
                $.get("http://" + hostname + ":8081/bootstrap/setup", function(data) {

                    if(data.setup == false) {
                        let formArray = [];

                        // Select a Database Source
                        formArray.push("<form id='bootstrapSetup'>");
                        formArray.push("<p>Select your database service:</p>");
                        formArray.push("<div class='form-check'>");
                        formArray.push("<input class='form-check-input' type='radio' name='dbService' id='sqlite-radio' value='sqlite' checked>");                        
                        formArray.push("<label class='form-check-label' for='sqlite-radio' data-toggle='tooltip' title='Uses only SQLite as database locally.'>SQLite</label>");
                        formArray.push("</div>");

                        formArray.push("<div class='form-check disabled'>"); // TODO: Disabled until this can be developed later. SQLite is priority
                        formArray.push("<input class='form-check-input' type='radio' name='dbService' id='mariadb-radio' value='mariadb' disabled>");
                        formArray.push("<label class='form-check-label' for='mariadb-radio' data-toggle='tooltip' title='Uses external MariaDB instance as database.\rSQLite will still be installed locally for config store.'>MariaDB</label>");
                        formArray.push("</div><br />");

                        // External DB Form Input (not SQLite)
                        formArray.push("<div id='formExDB' style='display: none;'><div class='form-group'>");
                        formArray.push("<label for='dbAdminUser'>Database admin username:</label>");
                        formArray.push("<input type='text' class='form-control' id='dbAdminUser' aria-describedby='externalDBInput' placeholder=''>");
                        formArray.push("</div>");
                
                        formArray.push("<div class='form-group'>");
                        formArray.push("<label for='dbAdminPasswd'>Database admin password:</label>");
                        formArray.push("<input type='password' class='form-control' id='dbAdminPasswd' aria-describedby='externalDBInput' placeholder=''>");
                        formArray.push("</div>");
                
                        formArray.push("<div class='form-group'>");
                        formArray.push("<label for='dbAddress'>Database address:</label>");
                        formArray.push("<input type='text' class='form-control' id='dbAddress' aria-describedby='externalDBInput' placeholder='localhost'>");
                        formArray.push("</div>");
                
                        formArray.push("<div class='form-group'>");
                        formArray.push("<label for='dbPort'>Database port:</label>");
                        formArray.push("<input type='text' class='form-control' id='dbPort' aria-describedby='externalDBInput' placeholder=''>");
                        formArray.push("</div></div>");


                        // Bootstrap Budget Services
                        // TODO: Add Web service setup (Windows, Linux - Nginix, Linux - Apache2, etc.)
                        formArray.push("<hr / style='background-color: whitesmoke;'>");
                        formArray.push("<div class='form-group'>");
                        formArray.push("<label for='apiAddress'>API services address:</label>");
                        formArray.push("<input type='text' class='form-control' id='apiAddress' aria-describedby='bootstrapServices' placeholder='localhost'>");
                        formArray.push("</div>");
    
                        formArray.push("<div class='form-group'>");
                        formArray.push("<label for='apiPort'>API services port:</label>");
                        formArray.push("<input type='text' class='form-control' id='apiPort' aria-describedby='bootstrapServices' placeholder='8080'>");
                        formArray.push("</div>");
    
                        formArray.push("<div class='form-group'>");
                        formArray.push("<label for='adminPasswd'>Bootstrap administrator password:</label>");
                        formArray.push("<input type='password' class='form-control' id='adminPasswd' aria-describedby='bootstrapServices' placeholder=''>");
                        formArray.push("</div>");
    
                        formArray.push("<div class='form-group'>");
                        formArray.push("<label for='adminPasswdCheck'>Re-enter Bootstrap administrator password:</label>");
                        formArray.push("<input type='password' class='form-control' id='adminPasswdCheck' aria-describedby='bootstrapServices' placeholder=''>");
                        formArray.push("</div>");

                        formArray.push("<button type='button' class='btn btn-primary' id='submitBtn' style='display: block;' disabled>Submit</button>");
                        formArray.push("<button type='button' class='btn btn-primary' id='spinnerBtn'style='display: none;'>");
                        formArray.push("<span class='spinner-grow spinner-grow-sm' role='status' aria-hidden='true'></span>");
                        formArray.push("<span class='sr-only'>Loading...</span></button>");
                        formArray.push("</form>");

                        $("#bootstrap-setup-jumbo").html(formArray.join(""));
                    
                    } else {
                        let formArray = [];

                        formArray.push("<h3>You're all set!</h3>");
                        formArray.push("<p>From here you can close this setup service by entering <kbd><kbd>Ctrl</kbd> + <kbd>C</kbd></kbd> from the host terminal.</p>");
                        formArray.push("<p>Start the main Boostrap Budget service with <code>npm run start</code></p><br />");
                        formArray.push("<p>OR...if you want to delete the setup and start over, type the ADMIN password in the box below and click the button.</p>");
                        formArray.push("<form id='bootstrapStartOver'>");
                        formArray.push("<div class='form-group'>");
                        formArray.push("<label for='startOverPasswd'>Bootstrap administrator password:</label>");
                        formArray.push("<input type='password' class='form-control' id='startOverPasswd' aria-describedby='bootstrapServices' placeholder=''>");
                        formArray.push("</div>");
                        formArray.push("<button type='button' class='btn btn-danger' id='startOverBtn' disabled>Delete and Start Over</button>");
                        formArray.push("</form>");

                        $("#bootstrap-setup-jumbo").html(formArray.join(""));
                    }
                });
            });

            // Database Service Radio Change
            $(document).on('change', 'input:radio[name="dbService"]', function() {
                if(this.value == "sqlite") {
                    $("#formExDB").css("display", "none")

                } else {
                    $("#formExDB").css("display", "block")
                    $("#dbPort").attr("placeholder", "3306")
                }
            });

            // Bootstrap Admin Password Check - Setup
            // TODO: Set password parameters (length, characters, etc.)
            $(document).on('keyup', 'input[id="adminPasswd"], input[id="adminPasswdCheck"]', function() {
                if($('input[id="adminPasswd"], input[id="adminPasswdCheck').val().length == 0) {
                    $('input[id="adminPasswd"], input[id="adminPasswdCheck').css("background-color", "White")
                    $("#submitBtn").prop("disabled", true);

                } else {
                    if($('input[id="adminPasswd"]').val() != $('input[id="adminPasswdCheck"]').val()) {
                        $('input[id="adminPasswd"], input[id="adminPasswdCheck"]').css("background-color", "LightPink")

                    } else {
                        $('input[id="adminPasswd"], input[id="adminPasswdCheck"]').css("background-color", "LightGreen")
                        $("#submitBtn").prop("disabled", false);
                    }
                }
            });

            // Bootstrap Admin Password Check - Start Over
            $(document).on('keyup', 'input[id="startOverPasswd"]', function() {
                if($('input[id="startOverPasswd').val().length == 0) {
                    $("#startOverBtn").prop("disabled", true);
                } else {
                    $("#startOverBtn").prop("disabled", false);
                }
            });

            $(document).on('click', '#submitBtn', function() {
                // Establish config object
                let config = {};

                config.db_service = $('input[name="dbService"]').val();
                config.services_address = $('input[id="apiAddress"]').attr("placeholder");
                config.services_port = $('input[id="apiPort"]').attr("placeholder");

                /*
                if(config.db_service == "mariadb") {
                            config.db_username = answers.db_username;
                            config.db_password = answers.db_password;
                            config.db_address = answers.db_address;
                            config.db_port = answers.db_port;
                        }

                */

                if($('input[id="apiAddress"]').val().length > 0) {
                    config.services_address = $('input[id="apiAddress"]').val();
                }

                if($('input[id="apiPort"]').val().length > 0) {
                    config.services_port = $('input[id="apiPort"]').val();
                }

                if($('input[id="adminPasswd"], input[id="adminPasswdCheck').val().length == 0) {
                    alert("Password MUST be provided!");

                } else {

                    if($('input[id="adminPasswd"]').val() != $('input[id="adminPasswdCheck"]').val()) {
                        alert("Passwords do NOT match. Please enter matching passwords.");

                    } else {
                        $("#submitBtn").css("display", "none");
                        $("#spinnerBtn").css("display", "block");

                        config.admin_password = $('input[id="adminPasswd"]').val();

                        //alert(JSON.stringify(config));
                        var postConfg = $.post("http://" + hostname + ":8081/bootstrap/setup/sqlite", config);
                        
                        postConfg.done(function(data) { location.reload(true); }); 
                        postConfg.fail(function() { alert("Failed to complete setup!"); location.reload(true); });
                    }
                }
            });

            $(document).on('click', '#startOverBtn', function() {
                // Establish so object
                let startover = {};

                //alert($('input[id="startOverPasswd"]').val());

                startover.admin_password = $('input[id="startOverPasswd"]').val();

                $.post("http://" + hostname + ":8081/bootstrap/startover", startover)
                    .done(function(data) {
                        //alert(JSON.stringify(data));

                        if(data.startover) {
                            location.reload(true); 
                        } else {
                            alert("Admin password does not match!");
                        }
                    })
                    .fail(function() { 
                        alert("Failed to send startover!"); 
                        //location.reload(true); 
                    });
            });
        </script>

    </head>

    <body>

        <nav class="navbar navbar-dark bg-dark navbar-expand-xl">

            <ul class="navbar-nav">
            
                <li class="nav-item active">
                  <a class="nav-link" href="#"><h5>Bootstrap Budget! Setup</h5></a>
                </li>
            
            </ul>

        </nav>

        <div class="container my-5">

            <div class="jumbotron bg-dark text-light" id="bootstrap-setup-jumbo"></div>
        
        </div>

    </body>

</html>